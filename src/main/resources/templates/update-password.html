<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Redefinir Senha - VidaPlus</title>
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .valid-req { color: #27ae60; font-size: 0.85rem; transition: 0.3s; margin-bottom: 3px; }
        .invalid-req { color: #e74c3c; font-size: 0.85rem; transition: 0.3s; margin-bottom: 3px; }
        .req-icon { margin-right: 5px; width: 15px; display: inline-block; text-align: center; }
        .password-box { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
    </style>
</head>
<body style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f7f6;">
    <div class="login-container" style="width: 100%; max-width: 400px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        
        <div class="login-header" style="text-align: center; margin-bottom: 20px;">
            <h2 style="color: #20c997;"><i class="fas fa-lock"></i> Nova Senha</h2>
            <p style="color: #666;">Crie uma senha forte para sua segurança.</p>
        </div>

        <div th:if="${error}" class="alert-erro" style="background: #fdecea; color: #e74c3c; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center;">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${error}">Erro</span>
        </div>

        <form th:action="@{/update-password}" method="post" id="formSenha">
            <input type="hidden" name="token" th:value="${tokenValidado}">

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #333;">Nova Senha</label>
                <div class="input-icon" style="position: relative;">
                    <i class="fas fa-key" style="position: absolute; left: 10px; top: 10px; color: #aaa;"></i>
                    <input type="password" id="senha" name="senha" placeholder="Digite a nova senha" required onkeyup="validarSenha()" class="form-control" style="width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>

            <div class="password-box">
                <div id="req-length" class="invalid-req"><i class="fas fa-times req-icon"></i> Mínimo 8 caracteres</div>
                <div id="req-upper" class="invalid-req"><i class="fas fa-times req-icon"></i> Letra Maiúscula (A-Z)</div>
                <div id="req-lower" class="invalid-req"><i class="fas fa-times req-icon"></i> Letra Minúscula (a-z)</div>
                <div id="req-number" class="invalid-req"><i class="fas fa-times req-icon"></i> Número (0-9)</div>
                <div id="req-special" class="invalid-req"><i class="fas fa-times req-icon"></i> Símbolo (@#$%...)</div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #333;">Confirmar Nova Senha</label>
                <div class="input-icon" style="position: relative;">
                    <i class="fas fa-check-double" style="position: absolute; left: 10px; top: 10px; color: #aaa;"></i>
                    <input type="password" id="confirmarSenha" name="confirmarSenha" placeholder="Repita a senha" required onkeyup="validarConfirmacao()" class="form-control" style="width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <small id="msgConfirmacao" style="display:none; margin-top:5px; font-weight:bold; font-size: 0.85rem;"></small>
            </div>

            <button type="submit" id="btnSalvar" class="btn-custom" disabled style="width: 100%; padding: 10px; background-color: #20c997; color: white; border: none; border-radius: 5px; font-size: 1rem; opacity: 0.6; cursor: not-allowed;">
                Atualizar Senha
            </button>
        </form>
        
        <div class="login-footer" style="text-align: center; margin-top: 15px;">
            <a th:href="@{/login}" style="color: #20c997; text-decoration: none;">Voltar ao Login</a>
        </div>
    </div>

    <script>
        function validarSenha() {
            const senha = document.getElementById('senha').value;
            
            // Regras Regex
            const hasLength = senha.length >= 8;
            const hasUpper = /[A-Z]/.test(senha);
            const hasLower = /[a-z]/.test(senha);
            const hasNumber = /[0-9]/.test(senha);
            const hasSpecial = /[@#$%^&+=!_]/.test(senha);

            // Atualiza a interface visualmente
            updateStatus('req-length', hasLength);
            updateStatus('req-upper', hasUpper);
            updateStatus('req-lower', hasLower);
            updateStatus('req-number', hasNumber);
            updateStatus('req-special', hasSpecial);

            validarConfirmacao(); // Verifica também a confirmação
        }

        function updateStatus(id, isValid) {
            const el = document.getElementById(id);
            const icon = el.querySelector('i');
            
            if (isValid) {
                el.className = 'valid-req';
                icon.className = 'fas fa-check req-icon';
            } else {
                el.className = 'invalid-req';
                icon.className = 'fas fa-times req-icon';
            }
        }

        function validarConfirmacao() {
            const senha = document.getElementById('senha').value;
            const confirmacao = document.getElementById('confirmarSenha').value;
            const btn = document.getElementById('btnSalvar');
            const msg = document.getElementById('msgConfirmacao');

            // Verifica se não há regras inválidas (todos os requisitos cumpridos)
            const senhaForte = document.querySelectorAll('.invalid-req').length === 0;
            const senhasIguais = (senha === confirmacao) && senha.length > 0;

            if (confirmacao.length > 0) {
                msg.style.display = 'block';
                if (senhasIguais) {
                    msg.style.color = '#27ae60';
                    msg.innerHTML = '<i class="fas fa-check"></i> Senhas conferem';
                } else {
                    msg.style.color = '#e74c3c';
                    msg.innerHTML = '<i class="fas fa-times"></i> Senhas não conferem';
                }
            } else {
                msg.style.display = 'none';
            }

            // Habilita o botão apenas se tudo estiver ok
            if (senhaForte && senhasIguais) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            }
        }
    </script>
</body>
</html>