<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Laboratório - VidaPlus</title>
    
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <th:block th:if="${_csrf} != null">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    </th:block>

    <style>
        /* (ESTILO MANTIDO ORIGINAL) */
        :root { --primary-lab: #20c997; --secondary-lab: #007bff; --warning-lab: #ffc107; --danger-lab: #dc3545; --dark-bg: #f8f9fc; }
        body { background-color: var(--dark-bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-container { padding: 30px; max-width: 1200px; margin: 0 auto; }
        .header-lab { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .header-lab h2 { margin: 0; color: #333; font-size: 1.5rem; }
        .btn-novo-pedido { background: linear-gradient(45deg, var(--primary-lab), #1baa80); color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(32, 201, 151, 0.4); transition: transform 0.2s; }
        .btn-novo-pedido:hover { transform: translateY(-2px); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid transparent; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .card-orange { border-left-color: var(--warning-lab); } .card-blue { border-left-color: var(--secondary-lab); } .card-green { border-left-color: var(--primary-lab); }
        .stat-info h3 { font-size: 2rem; margin: 0; font-weight: 700; color: #333; } .stat-info p { margin: 0; color: #777; font-size: 0.9rem; } .stat-icon { font-size: 2.5rem; opacity: 0.2; }
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 350px; position: relative; }
        .table-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table { width: 100%; border-collapse: collapse; } .table th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: #555; } .table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; } .badge-warning { background: #fff3cd; color: #856404; } .badge-success { background: #d4edda; color: #155724; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 650px; max-width: 95%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideDown 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; } .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        select[multiple] { border: 1px solid #20c997; background: #f8fcfb; } optgroup { font-weight: bold; color: #20c997; font-style: normal; padding: 5px; } option { padding: 5px; color: #333; margin-left: 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; } .btn-confirm { background: var(--primary-lab); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .row { display: flex; gap: 15px; } .col-md-6 { flex: 1; }
        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } .row { flex-direction: column; gap: 0; } }
    </style>
</head>
<body>

    <div th:replace="~{fragments/header :: navbar}"></div>

    <main class="dashboard-container">
        
        <div class="header-lab">
            <div>
                <h2><i class="fas fa-flask" style="color: var(--primary-lab)"></i> Painel Laboratorial</h2>
                <small class="text-muted">Gestão de exames e resultados</small>
            </div>
            <button class="btn-novo-pedido" onclick="abrirModal()">
                <i class="fas fa-plus-circle"></i> Novo Pedido
            </button>
        </div>

        <div class="kpi-grid">
            <div class="stat-card card-orange">
                <div class="stat-info">
                    <h3 id="kpiPendentes" th:text="${totalPendentes}">0</h3>
                    <p>Aguardando Pagamento</p>
                </div>
                <i class="fas fa-wallet stat-icon" style="color: var(--warning-lab)"></i>
            </div>
            
            <div class="stat-card card-blue">
                <div class="stat-info">
                    <h3 id="kpiAnalise" th:text="${totalAnalise}">0</h3>
                    <p>Em Análise Técnica</p>
                </div>
                <i class="fas fa-microscope stat-icon" style="color: var(--secondary-lab)"></i>
            </div>

            <div class="stat-card card-green">
                <div class="stat-info">
                    <h3 id="kpiConcluidos" th:text="${totalConcluidos}">0</h3>
                    <p>Prontos para Download</p>
                </div>
                <i class="fas fa-file-download stat-icon" style="color: var(--primary-lab)"></i>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-box">
                <h5 style="margin-top:0; color:#555;">Evolução de Solicitações</h5>
                <canvas id="chartEvolucao"></canvas>
            </div>
            <div class="chart-box">
                <h5 style="margin-top:0; color:#555;">Status Atual</h5>
                <div style="height: 250px; position: relative;">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>

        <div class="table-box">
            <h4 style="margin-top:0; margin-bottom:20px; color:#333;">Últimos Pedidos</h4>
            <div style="overflow-x:auto;">
                <table class="table" id="tabelaExames">
                    <thead>
                        <tr>
                            <th>Protocolo</th>
                            <th>Data</th>
                            <th>Exames Solicitados</th>
                            <th>Status</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="pedido : ${pedidos}">
                            <td th:text="'#' + ${pedido.id}">#000</td>
                            <td th:text="${#temporals.format(pedido.dataCriacao, 'dd/MM/yyyy')}">Data</td>
                            <td>
                                <div th:each="item : ${pedido.itens}">
                                    <small>• <span th:text="${item.nomeExame}">Exame</span></small>
                                </div>
                            </td>
                            <td>
                                <span class="badge" 
                                      th:classappend="${pedido.statusPagamento.name() == 'APROVADO'} ? 'badge-success' : 'badge-warning'"
                                      th:text="${pedido.statusPagamento.descricao}">Status</span>
                            </td>
                            <td>
                                <a th:if="${pedido.statusPagamento.name() == 'APROVADO'}" 
                                   th:href="@{/laboratorio/download/{id}(id=${pedido.id})}" 
                                   class="text-success"><i class="fas fa-download"></i> Baixar</a>
                                
                                <button th:if="${pedido.statusPagamento.name() == 'PENDENTE'}" 
                                        class="btn-novo-pedido" style="padding: 5px 15px; font-size: 0.8rem;"
                                        th:onclick="'pagar(' + ${pedido.id} + ')'">Pagar</button>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(pedidos)}">
                            <td colspan="5" style="text-align:center; color:#999; padding: 30px;">
                                <i class="fas fa-inbox fa-2x"></i><br>Nenhum pedido encontrado.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: rodape}"></div>

    <div id="modalNovoPedido" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0"><i class="fas fa-file-medical text-success"></i> Nova Solicitação</h3>
                <button onclick="fecharModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">&times;</button>
            </div>
            
            <p class="text-muted">Selecione os exames prescritos na guia médica. Segure <b>CTRL</b> para selecionar vários.</p>
            
            <form id="formPedido">
                <div class="form-group">
                    <label>Catálogo de Exames Disponíveis</label>
                    <select class="form-control" id="listaExames" multiple style="height: 250px;">
                        <optgroup label="--- HEMATOLOGIA ---">
                            <option value="HEMOGRAMA">Hemograma Completo</option>
                            <option value="TAP">Coagulograma</option>
                        </optgroup>
                        <optgroup label="--- BIOQUÍMICA ---">
                            <option value="GLICOSE">Glicose</option>
                            <option value="COLESTEROL">Colesterol Total</option>
                            <option value="UREIA">Ureia</option>
                            <option value="CREATININA">Creatinina</option>
                        </optgroup>
                         <optgroup label="--- ENDOCRINOLOGIA ---">
                            <option value="TSH">TSH</option>
                            <option value="T4L">T4 Livre</option>
                            <option value="VITD">Vitamina D</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Médico Solicitante</label>
                            <input type="text" id="nomeMedico" class="form-control" placeholder="CRM ou Nome">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="button" class="btn-confirm" onclick="enviarPedido()">
                        <i class="fas fa-check"></i> Gerar Protocolo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        function abrirModal() { document.getElementById('modalNovoPedido').style.display = 'flex'; }
        function fecharModal() { document.getElementById('modalNovoPedido').style.display = 'none'; }

        function enviarPedido() {
            const select = document.getElementById('listaExames');
            const selecionados = Array.from(select.selectedOptions).map(option => option.text);
            const medico = document.getElementById('nomeMedico').value;

            if(selecionados.length === 0) {
                alert('Selecione ao menos um exame.');
                return;
            }

            // Preparação dos Headers (Segurança + JSON)
            const headers = {
                'Content-Type': 'application/json'
            };

            // FIX: Verifica se os meta tags de CSRF existem antes de usar
            const csrfMeta = document.querySelector("meta[name='_csrf']");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']");
            
            if (csrfMeta && csrfHeader) {
                const token = csrfMeta.getAttribute("content");
                const headerName = csrfHeader.getAttribute("content");
                headers[headerName] = token;
            }

            // Envia para o Backend (Java)
            fetch('/laboratorio/criar-pedido', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    exames: selecionados,
                    medico: medico
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Pedido gerado com sucesso!');
                    window.location.reload(); // Recarrega para aparecer na tabela
                } else {
                    alert('Erro ao salvar pedido. Verifique o console.');
                    console.error("Erro na requisição:", response);
                }
            })
            .catch(error => console.error('Erro de rede:', error));
            
            fecharModal();
        }

        function pagar(id) { alert('Redirecionando para pagamento... Pedido: ' + id); }

        // Gráficos
        document.addEventListener('DOMContentLoaded', function() {
            const p = /*[[${totalPendentes}]]*/ 0;
            const a = /*[[${totalAnalise}]]*/ 0;
            const c = /*[[${totalConcluidos}]]*/ 0;

            if(document.getElementById('chartStatus')){
                new Chart(document.getElementById('chartStatus'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Concluídos', 'Em Análise', 'Pendentes'],
                        datasets: [{ data: [c, a, p], backgroundColor: ['#20c997', '#007bff', '#ffc107'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            if(document.getElementById('chartEvolucao')){
                new Chart(document.getElementById('chartEvolucao'), {
                    type: 'bar',
                    data: {
                        labels: ['Ago', 'Set', 'Out', 'Nov', 'Dez', 'Jan'],
                        datasets: [{ label: 'Exames', data: [5, 8, 3, 5, 2, 3], backgroundColor: '#007bff', borderRadius: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { display: false } } } }
                });
            }
        });
    </script>
</body>
</html>