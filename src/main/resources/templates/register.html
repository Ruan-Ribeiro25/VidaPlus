<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cadastro - VidaPlus</title>
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    
    <div th:replace="~{fragments/header :: navbar}"></div>

    <main>
        <div class="login-container" style="width: 100%; max-width: 600px; padding: 30px;">
            <div class="login-header" style="text-align: center;">
                <h2 style="color: #20c997;">Criar Conta</h2>
                <p>Preencha todos os dados abaixo</p>
            </div>

            <div th:if="${error}" class="alert-erro" style="background:#fdecea; color:#e74c3c; padding:10px; text-align:center; margin-bottom:15px; border-radius:5px;">
                <span th:text="${error}"></span>
            </div>

            <form th:action="@{/register}" th:object="${usuario}" method="post">
                
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" th:field="*{nome}" class="form-control" placeholder="Seu nome" required>
                </div>

                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>CPF</label>
                        <input type="text" th:field="*{cpf}" class="form-control" placeholder="000.000.000-00" required>
                    </div>
                    <div>
                        <label>RG</label>
                        <input type="text" th:field="*{rg}" class="form-control" placeholder="00.000.000-0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Data de Nascimento</label>
                    <input type="date" th:field="*{dataNascimento}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Cartão SUS</label>
                    <input type="text" th:field="*{cartaoSus}" class="form-control" placeholder="Número do cartão SUS" required>
                </div>

                <h4 style="color: #666; margin: 15px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px;">Endereço e Polo</h4>
                
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                    <div>
                        <label>CEP</label>
                        <input type="text" th:field="*{cep}" class="form-control" required>
                    </div>
                    
                    <div>
                        <label>Cidade (Polo de Atuação)</label>
                        <select th:field="*{cidade}" id="selectCidade" class="form-control" style="width: 100%;" required>
                            <option value="">Carregando cidades...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                    <div>
                        <label>Logradouro</label>
                        <input type="text" th:field="*{logradouro}" class="form-control" placeholder="Rua..." required>
                    </div>
                    <div>
                        <label>Número</label>
                        <input type="text" th:field="*{numero}" class="form-control" placeholder="123" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Bairro</label>
                    <input type="text" th:field="*{bairro}" class="form-control" placeholder="Bairro" required>
                </div>

                <h4 style="color: #666; margin: 15px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px;">Acesso</h4>

                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" th:field="*{email}" class="form-control" placeholder="seu@email.com" required>
                </div>

                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" th:field="*{senha}" id="senha" class="form-control" onkeyup="validarSenha()" placeholder="Mínimo 8 caracteres" required>
                    <div id="password-requirements" class="password-req">
                        <div id="req-length" class="req-item"><i class="fas fa-times"></i> Mínimo 8 caracteres</div>
                        <div id="req-upper" class="req-item"><i class="fas fa-times"></i> Letra Maiúscula</div>
                        <div id="req-number" class="req-item"><i class="fas fa-times"></i> Número</div>
                        <div id="req-special" class="req-item"><i class="fas fa-times"></i> Símbolo Especial</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Confirmar Senha</label>
                    <input type="password" name="confirmarSenha" id="confirmarSenha" class="form-control" onkeyup="validarConfirmacao()" placeholder="Repita a senha" required>
                    <small id="msgConfirmacao" style="display:none; font-weight:bold; margin-top:5px;"></small>
                </div>

                <button type="submit" id="btnRegistrar" class="btn-custom" disabled style="width:100%; padding:10px; background:#20c997; color:white; border:none; border-radius:5px; margin-top:10px; opacity:0.6; cursor:not-allowed;">
                    Cadastrar
                </button>
            </form>

            <div class="login-footer" style="text-align: center; margin-top: 15px;">
                <a th:href="@{/login}" style="color: #20c997;">Já tenho conta</a>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: rodape}"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // 1. Configuração do Select2 e API do IBGE
        $(document).ready(function() {
            // Inicializa o Select2 no campo cidade
            $('#selectCidade').select2({
                placeholder: "Pesquise sua cidade...",
                allowClear: true,
                language: {
                    noResults: function() {
                        return "Cidade não encontrada";
                    }
                }
            });

            // Busca todas as cidades do Brasil na API do IBGE
            const urlIBGE = "https://servicodados.ibge.gov.br/api/v1/localidades/municipios";
            
            fetch(urlIBGE)
                .then(response => response.json())
                .then(data => {
                    // Ordena as cidades por nome
                    data.sort((a, b) => a.nome.localeCompare(b.nome));

                    let options = '<option value="">Selecione a cidade...</option>';
                    data.forEach(cidade => {
                        // Salva "Nome" como valor
                        let valor = `${cidade.nome}`; 
                        options += `<option value="${valor}">${valor}</option>`;
                    });
                    
                    $('#selectCidade').html(options);
                })
                .catch(err => console.error("Erro ao carregar cidades:", err));
        });

        // 2. Validação de Senha (Mantida Original)
        function validarSenha() {
            const senha = document.getElementById('senha').value;
            document.getElementById('password-requirements').style.display = 'block';
            updateItem('req-length', senha.length >= 8);
            updateItem('req-upper', /[A-Z]/.test(senha));
            updateItem('req-number', /[0-9]/.test(senha));
            updateItem('req-special', /[@#$%^&+=!_]/.test(senha));
            validarConfirmacao();
        }
        function updateItem(id, valid) {
            const el = document.getElementById(id);
            if (valid) {
                el.classList.add('valid');
                el.innerHTML = '<i class="fas fa-check"></i> ' + el.innerText.replace('Create', '').trim();
            } else {
                el.classList.remove('valid');
            }
        }
        function validarConfirmacao() {
            const senha = document.getElementById('senha').value;
            const confirmacao = document.getElementById('confirmarSenha').value;
            const msg = document.getElementById('msgConfirmacao');
            const btn = document.getElementById('btnRegistrar');
            const senhasIguais = (senha === confirmacao) && senha.length > 0;
            const regrasOk = document.querySelectorAll('.req-item.valid').length >= 4;

            if (confirmacao.length > 0) {
                msg.style.display = 'block';
                if (senhasIguais) { msg.style.color = '#28a745'; msg.innerText = 'Senhas conferem'; }
                else { msg.style.color = '#dc3545'; msg.innerText = 'Senhas não conferem'; }
            }
            if (senhasIguais && regrasOk) {
                btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed';
            }
        }
    </script>
</body>
</html>