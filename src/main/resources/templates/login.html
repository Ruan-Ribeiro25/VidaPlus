<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Login - VidaPlus</title>
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div th:replace="~{fragments/header :: navbar}"></div>

    <main class="main-center">
        <div class="login-container">
            <div class="login-header">
                <h2><i class="fas fa-heartbeat" style="color: #20c997;"></i> VidaPlus</h2>
                <p>Gest칚o Hospitalar Inteligente</p>
            </div>

            <div th:if="${param.error}" class="alert-box alert-error">
                <i class="fas fa-exclamation-circle"></i> Usu치rio ou senha inv치lidos.
            </div>

            <div th:if="${param.disabled}" class="alert-box alert-blocked">
                <i class="fas fa-user-lock"></i> 
                <div><strong>Acesso Bloqueado</strong><br>Aguarde aprova칞칚o do administrador.</div>
            </div>

            <div th:if="${param.logout}" class="alert-box" style="background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0;">
                <i class="fas fa-sign-out-alt"></i> Logout realizado com sucesso.
            </div>

            <div id="geo-error" class="alert-box alert-blocked" style="display: none; background: #fee2e2; color: #991b1b; border: 1px solid #f87171;">
                <i class="fas fa-map-marker-alt"></i> 
                <div>
                    <strong>Localiza칞칚o Obrigat칩ria!</strong><br>
                    Voc칡 deve permitir o acesso  sua localiza칞칚o para fazer login e registrar seu polo atual.
                </div>
            </div>

            <form id="loginForm" th:action="@{/login}" method="post">
                
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">

                <div class="form-group">
                    <label>Login</label>
                    <div class="input-icon-wrapper">
                        <input type="text" name="username" class="form-control" placeholder="CPF ou Username" required autofocus>
                        <i class="fas fa-user input-icon-left"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label>Senha</label>
                    <div class="input-icon-wrapper">
                        <input type="password" name="password" class="form-control" placeholder="Sua senha" required>
                        <i class="fas fa-lock input-icon-left"></i>
                    </div>
                </div>

                <div class="forgot-wrapper">
                    <a th:href="@{/forgot-password}" class="forgot-link">Esqueceu a senha?</a>
                </div>

                <button type="submit" id="btnLogin" class="btn-custom">
                    ENTRAR <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </form>

            <div class="login-footer">
                <p>N칚o possui acesso?</p>
                <a th:href="@{/register}">Solicitar Cadastro</a>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: rodape}"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById('loginForm');
            const btnLogin = document.getElementById('btnLogin');
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            const geoErrorBox = document.getElementById('geo-error');

            function mostrarErroGeo(msg) {
                geoErrorBox.style.display = 'flex'; // Exibe o alerta
                // Opcional: Desabilitar bot칚o visualmente
                btnLogin.style.opacity = '0.6';
                btnLogin.style.cursor = 'not-allowed';
            }

            function ocultarErroGeo() {
                geoErrorBox.style.display = 'none';
                btnLogin.style.opacity = '1';
                btnLogin.style.cursor = 'pointer';
            }

            // 1. Tenta pegar a localiza칞칚o ao carregar
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // Sucesso: Preenche e libera
                        latInput.value = position.coords.latitude;
                        lonInput.value = position.coords.longitude;
                        ocultarErroGeo();
                        console.log("游늸 Localiza칞칚o capturada:", latInput.value, lonInput.value);
                    },
                    function(error) {
                        // Erro/Nega칞칚o: Mostra alerta
                        console.warn("Permiss칚o de localiza칞칚o negada.");
                        mostrarErroGeo();
                    },
                    { timeout: 10000, enableHighAccuracy: true }
                );
            } else {
                alert("Seu navegador n칚o suporta geolocaliza칞칚o. O login n칚o ser치 poss칤vel.");
            }

            // 2. Intercepta o envio do formul치rio (Trava de Seguran칞a)
            form.addEventListener('submit', function(event) {
                if (!latInput.value || !lonInput.value) {
                    event.preventDefault(); // IMPEDE O LOGIN
                    mostrarErroGeo();
                    
                    // Tenta pedir permiss칚o novamente com for칞a
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            latInput.value = position.coords.latitude;
                            lonInput.value = position.coords.longitude;
                            ocultarErroGeo();
                            // Se conseguir agora, submete o formul치rio
                            form.submit();
                        },
                        function(error) {
                            alert("ERRO CR칈TICO: A geolocaliza칞칚o 칠 uma regra de neg칩cio obrigat칩ria.\n\nPor favor, habilite a permiss칚o no 칤cone de cadeado do seu navegador e recarregue a p치gina.");
                        }
                    );
                }
            });
        });
    </script>

</body>
</html>