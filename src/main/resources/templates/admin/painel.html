<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Administração - VidaPlus</title> 
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div th:replace="~{fragments/header :: navbar}"></div>

    <main class="container-fluid mt-4">
        
        <div class="page-header mb-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                
                <a th:href="@{/home}" title="Voltar para Home" class="me-4 text-white" style="font-size: 1.5rem; text-decoration: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-arrow-left"></i>
                </a>

                <div class="position-relative me-3">
                    <img th:src="${usuario.fotoPerfil != null} ? 'data:image/jpeg;base64,' + ${usuario.fotoPerfil} : '/img/avatar-default.png'" 
                         class="profile-pic-header" alt="Perfil">
                    
                    <form th:action="@{/perfil/upload-foto}" method="post" enctype="multipart/form-data" class="position-absolute" style="bottom: -2px; right: -5px;">
                        <label class="btn-upload-icon mb-0 shadow-sm" title="Alterar Foto" 
                               style="cursor: pointer; background-color: #ffffff !important; color: #20c997 !important; border: 2px solid #fff !important; width: 22px !important; height: 22px !important; font-size: 10px !important; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                            <i class="fas fa-camera"></i>
                            <input type="file" name="image" onchange="this.form.submit()" style="display: none;">
                        </label>
                    </form>
                </div>

                <div>
                    <h2 class="mb-0" style="color: #ffffff !important; text-shadow: 0 2px 5px rgba(0,0,0,0.8); font-weight: 700;">
                        <i class="fas fa-user-shield"></i> Painel Administrativo
                    </h2>
                    <small style="color: #f0f0f0 !important; text-shadow: 0 1px 3px rgba(0,0,0,0.8); font-size: 0.95rem;">
                        Bem-vindo(a), <span th:text="${usuario.nome}" style="font-weight: bold;">Admin</span>
                    </small>
                </div>
            </div>

            <div class="user-info">
                <span class="badge bg-dark border border-light">ADMIN MASTER</span>
            </div>
        </div>
        
        <div th:if="${param.msg != null || param.error != null}" class="mb-4">
            <div th:if="${param.msg == 'excluido'}" class="alert alert-success d-flex align-items-center"><i class="fas fa-trash me-2"></i> Usuário excluído e motivo registrado!</div>
            <div th:if="${param.msg == 'bloqueado'}" class="alert alert-warning d-flex align-items-center"><i class="fas fa-ban me-2"></i> Usuário bloqueado com sucesso.</div>
            <div th:if="${param.msg == 'aprovado'}" class="alert alert-success d-flex align-items-center"><i class="fas fa-check me-2"></i> Usuário aprovado com sucesso.</div>
            <div th:if="${param.error == 'ultimo_admin'}" class="alert alert-danger"><i class="fas fa-user-shield me-2"></i> Segurança: Você não pode excluir o último administrador.</div>
        </div>

        <div class="grid-refined">
            
            <a th:href="@{/financeiro}" class="card-refined card-financeiro" style="text-decoration: none; color: inherit;">
                <div>
                    <div class="refined-value">R$ <span th:text="${faturamentoMensal}">1.2M</span></div>
                    <div class="refined-label">Faturamento Mensal</div>
                </div>
                <div class="refined-subtext">
                    <i class="fas fa-arrow-up text-success"></i> <span class="text-success fw-bold" th:text="${crescimentoFinanceiro}">15</span>% de crescimento
                </div>
                <i class="fas fa-hand-holding-usd refined-icon-bg" style="color: #20c997;"></i>
            </a>

            <a th:href="@{/admin/ambulancias}" class="card-refined card-ambulancia">
                <div>
                    <div class="refined-value" th:text="${totalAmbulancias}">0</div>
                    <div class="refined-label">Gestão de Ambulância</div>
                </div>
                <div class="refined-subtext">
                    <i class="fas fa-truck-medical"></i> 
                    <span class="text-dark fw-bold" th:text="${ambEmChamado}">0</span> Em Chamado &bull; 
                    <span class="text-dark fw-bold" th:text="${ambNaBase}">0</span> Base
                </div>
                <i class="fas fa-ambulance refined-icon-bg" style="color: #0dcaf0;"></i>
            </a>

            <div class="card-refined card-leitos">
                <div>
                    <div class="refined-value"><span th:text="${leitosOcupacaoPerc}">84</span>%</div>
                    <div class="refined-label">Ocupação de Leitos</div>
                </div>
                <div class="refined-subtext">
                    <i class="fas fa-bed"></i> <span th:text="${leitosOcupados}">42</span> Ocupados / <span th:text="${leitosVagos}">8</span> Livres
                </div>
                <i class="fas fa-procedures refined-icon-bg" style="color: #3498db;"></i>
            </div>

            <a th:href="@{/admin/estoque}" class="card-refined card-estoque">
                <div>
                    <div class="refined-value" th:text="${totalProdutos}">0</div>
                    <div class="refined-label">Farmácia & Estoque</div>
                </div>
                <div class="refined-subtext" th:if="${alertaEstoque > 0}" style="color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle"></i> <strong><span th:text="${alertaEstoque}">0</span> Itens em Baixo Estoque!</strong>
                </div>
                <div class="refined-subtext" th:unless="${alertaEstoque > 0}" style="color: #198754;">
                    <i class="fas fa-check-circle"></i> Estoque Saudável
                </div>
                <i class="fas fa-pills refined-icon-bg" style="color: #f39c12;"></i>
            </a>

            <div class="kpi-card-pro card-polo">
                <a th:href="@{/admin/detalhes/POLOS}" class="card-link">
                    <div><div class="kpi-value-pro" th:text="${totalPolos}">0</div><div class="kpi-label-pro">Unidades / Polos</div></div>
                    <i class="fas fa-hospital kpi-icon-bg icon-theme"></i>
                </a>
            </div>

            <div class="kpi-card-pro card-excluido">
                <a th:href="@{/admin/detalhes/EXCLUIDOS}" class="card-link">
                    <div><div class="kpi-value-pro" th:text="${totalExcluidos}">0</div><div class="kpi-label-pro">Histórico Excluídos</div></div>
                    <i class="fas fa-user-times kpi-icon-bg icon-theme"></i>
                </a>
            </div>

            <div class="kpi-card-pro card-logs">
                <a th:href="@{/admin/detalhes/LOGS}" class="card-link">
                    <div><div class="kpi-value-pro" th:text="${totalLogs}">0</div><div class="kpi-label-pro">Logs do Sistema</div></div>
                    <i class="fas fa-clipboard-list kpi-icon-bg icon-theme"></i>
                </a>
            </div>

            <div class="kpi-card-pro card-volume">
                <a th:href="@{/admin/detalhes/VOLUME}" class="card-link">
                    <div><div class="kpi-value-pro" th:text="${volumeHoje}">0</div><div class="kpi-label-pro">Tráfego Hoje</div></div>
                    <i class="fas fa-chart-line kpi-icon-bg icon-theme"></i>
                </a>
            </div>

            <div class="kpi-card-pro card-laboratorio" style="border-bottom-color: #d63384;">
                <a th:href="@{/admin/laboratorio}" class="card-link">
                    <div>
                        <div class="kpi-value-pro" style="color: #d63384;" th:text="${totalLaboratorios}">0</div>
                        <div class="kpi-label-pro">Gestão do Laboratório</div>
                    </div>
                    <i class="fas fa-microscope kpi-icon-bg icon-theme" style="color: #d63384;"></i>
                </a>
            </div>

        </div>

        <div class="row mb-4 mt-4">
            <div class="col-lg-4">
                <div class="card shadow-sm mb-4 h-100">
                    <div class="card-header py-3 bg-white"><h6 class="m-0 fw-bold text-primary">Distribuição do Ecossistema</h6></div>
                    <div class="card-body"><div class="chart-pie pt-4 pb-2"><canvas id="chartUsuarios"></canvas></div></div>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4 h-100">
                    <div class="card-header py-3 bg-white"><h6 class="m-0 fw-bold text-primary">Status Operacional</h6></div>
                    <div class="card-body">
                        <div class="alert alert-secondary">
                            <p class="mb-1"><i class="fas fa-server me-2"></i> <strong>Servidor:</strong> <span class="text-success">Online (Porta 8080)</span></p>
                            <p class="mb-1"><i class="fas fa-database me-2"></i> <strong>Banco de Dados:</strong> Conectado (MySQL)</p>
                            <p class="mb-0"><i class="fas fa-clock me-2"></i> <strong>Último Backup:</strong> Hoje, 03:00 AM</p>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Ações Pendentes:</small>
                            <div th:if="${totalPendentes > 0}" class="alert alert-warning mt-2 d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-exclamation-triangle"></i> Existem <strong><span th:text="${totalPendentes}"></span></strong> profissionais aguardando aprovação.</span>
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div th:unless="${totalPendentes > 0}" class="alert alert-success mt-2">
                                <i class="fas fa-check-circle"></i> Nenhuma pendência de cadastro.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 border-top-danger" th:if="${totalPendentes > 0}">
            <div class="card-header bg-white py-3"><h5 class="m-0 fw-bold text-danger"><i class="fas fa-user-lock"></i> Aprovações Necessárias</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead class="table-light"><tr><th>Nome</th><th>Perfil</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody>
                            <tr th:each="u : ${todosUsuarios}" th:if="${!u.ativo}">
                                <td th:text="${u.nome}">Nome</td>
                                <td th:text="${u.perfil}">PERFIL</td>
                                <td class="text-warning fw-bold">Pendente</td>
                                <td>
                                    <form th:action="@{/admin/aprovar-profissional}" method="post">
                                        <input type="hidden" name="idUsuario" th:value="${u.id}">
                                        <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check"></i> Aprovar Acesso</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-primary"><i class="fas fa-users-cog"></i> Diretório Global de Usuários</h5>
                <form th:action="@{/admin/painel}" method="get" class="d-flex">
                    <input type="text" name="busca" class="form-control form-control-sm me-2 input-search-admin" placeholder="Buscar nome ou CPF...">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i></button>
                </form>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>ID</th><th>Nome / Email</th><th>Perfil</th><th>Cidade</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="u : ${todosUsuarios}">
                                <td th:text="${u.id}">1</td>
                                <td><div class="fw-bold" th:text="${u.nome}">Nome</div><small class="text-muted" th:text="${u.email}">email</small></td>
                                <td><span class="badge bg-secondary" th:text="${u.perfil}">PERFIL</span></td>
                                <td th:text="${u.cidade} ?: 'N/I'">Cidade</td>
                                <td><span th:if="${u.ativo}" class="badge bg-success">Ativo</span><span th:unless="${u.ativo}" class="badge bg-danger">Bloqueado</span></td>
                                <td class="text-nowrap">
                                    <button type="button" class="btn-action btn-eye" data-bs-toggle="modal" th:data-bs-target="'#modalInfo' + ${u.id}" title="Ver Ficha"><i class="fas fa-eye"></i></button>
                                    <form th:if="${u.ativo}" th:action="@{/admin/bloquear-usuario}" method="post" class="d-inline">
                                        <input type="hidden" name="idUsuario" th:value="${u.id}">
                                        <button type="submit" class="btn-action btn-block" title="Bloquear"><i class="fas fa-ban"></i></button>
                                    </form>
                                    <form th:unless="${u.ativo}" th:action="@{/admin/aprovar-profissional}" method="post" class="d-inline">
                                        <input type="hidden" name="idUsuario" th:value="${u.id}">
                                        <button type="submit" class="btn-action btn-approve" title="Reativar"><i class="fas fa-check-circle"></i></button>
                                    </form>
                                    <button type="button" class="btn-action btn-delete" data-bs-toggle="modal" th:data-bs-target="'#modalExcluir' + ${u.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                    
                                    <div class="modal fade" th:id="'modalInfo' + ${u.id}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header modal-header-admin"><h5 class="modal-title"><i class="fas fa-id-card me-2"></i>Ficha Cadastral: <span th:text="${u.nome}"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                                                <div class="modal-body">
                                                    <div class="container-fluid">
                                                        <div class="row">
                                                            <div class="col-12 mb-2 border-bottom pb-1 text-primary fw-bold"><i class="fas fa-user me-1"></i> Dados Pessoais</div>
                                                            <div class="col-md-4"><div class="info-label">CPF</div><div class="info-value" th:text="${u.cpf} ?: '---'"></div></div>
                                                            <div class="col-md-4"><div class="info-label">RG</div><div class="info-value" th:text="${u.rg} ?: '---'"></div></div>
                                                            <div class="col-md-4"><div class="info-label">Data Nasc.</div><div class="info-value" th:text="${u.dataNascimento} ?: '---'"></div></div>
                                                            <div class="col-md-6"><div class="info-label">Email / Login</div><div class="info-value" th:text="${u.email}"></div></div>
                                                            <div class="col-md-6"><div class="info-label">Telefone</div><div class="info-value" th:text="${u.telefone} ?: '---'"></div></div>
                                                            <div class="col-md-12"><div class="info-label">Cartão SUS</div><div class="info-value" th:text="${u.cartaoSus} ?: 'Não informado'"></div></div>
                                                            <div class="col-12 mt-3 mb-2 border-bottom pb-1 text-primary fw-bold"><i class="fas fa-map-marker-alt me-1"></i> Endereço</div>
                                                            <div class="col-md-8"><div class="info-label">Logradouro</div><div class="info-value" th:text="${u.logradouro} ?: '---'"></div></div>
                                                            <div class="col-md-4"><div class="info-label">Número</div><div class="info-value" th:text="${u.numero} ?: '---'"></div></div>
                                                            <div class="col-md-4"><div class="info-label">Bairro</div><div class="info-value" th:text="${u.bairro} ?: '---'"></div></div>
                                                            <div class="col-md-4"><div class="info-label">Cidade / UF</div><div class="info-value"><span th:text="${u.cidade} ?: '---'"></span> - <span th:text="${u.uf} ?: '-'"></span></div></div>
                                                            <div class="col-md-4"><div class="info-label">CEP</div><div class="info-value" th:text="${u.cep} ?: '---'"></div></div>
                                                            <div class="col-12 mt-3 mb-2 border-bottom pb-1 text-primary fw-bold" th:if="${#strings.contains(u.perfil, 'MEDICO') or #strings.contains(u.perfil, 'ENFERMEIRO')}"><i class="fas fa-user-md me-1"></i> Dados do Profissional</div>
                                                            <th:block th:if="${mapaProfissionais != null and mapaProfissionais.containsKey(u.id)}">
                                                                <div class="col-md-4"><div class="info-label">Registro Oficial</div><div class="info-value"><span th:if="${#strings.contains(u.perfil, 'MEDICO')}" class="fw-bold text-dark">CRM: <span th:text="${mapaProfissionais.get(u.id).crm}"></span></span><span th:if="${#strings.contains(u.perfil, 'ENFERMEIRO')}" class="fw-bold text-dark">COREN: <span th:text="${mapaProfissionais.get(u.id).coren}"></span></span></div></div>
                                                                <div class="col-md-4"><div class="info-label">Matrícula Interna</div><div class="info-value" th:text="${mapaProfissionais.get(u.id).matricula}"></div></div>
                                                                <div class="col-md-4"><div class="info-label">Especialidade</div><div class="info-value" th:text="${mapaProfissionais.get(u.id).especialidade}"></div></div>
                                                                <div class="col-md-6"><div class="info-label">Status Credenciamento</div><div class="info-value fw-bold text-success"><i class="fas fa-check-circle"></i> <span th:text="${mapaProfissionais.get(u.id).statusAprovacao}"></span></div></div>
                                                            </th:block>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer bg-light"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="modal fade" th:id="'modalExcluir' + ${u.id}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form th:action="@{/admin/excluir-usuario}" method="post">
                                                    <div class="modal-header bg-danger text-white"><h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                                                    <div class="modal-body">
                                                        <p class="text-center fw-bold fs-5">Você está prestes a excluir:<br><span class="text-danger" th:text="${u.nome}"></span></p>
                                                        <div class="alert alert-warning small"><i class="fas fa-info-circle"></i> Esta ação é irreversível.</div>
                                                        <div class="mb-3 text-start"><label for="motivo" class="form-label fw-bold">Motivo da Exclusão:</label><textarea name="motivo" id="motivo" class="form-control" rows="3" required></textarea></div>
                                                        <input type="hidden" name="idUsuario" th:value="${u.id}">
                                                    </div>
                                                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-danger">Confirmar</button></div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div th:replace="~{fragments/footer :: rodape}"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        // LABELS: Forçados aqui para garantir que a legenda apareça completa
        var labels = [
            'Pacientes', 'Médicos', 'Enfermeiros', 'Admins', 
            'Polos', 'Excluídos', 'Motoristas', 'Técnicos', 
            'Clínicas', 'Laboratórios', 'Sv. Gerais', 'Ambulâncias'
        ];
        
        // DADOS: Recebe do backend (Java agora envia 12 valores)
        var dados = /*[[${graficoDados}]]*/ [];

        document.addEventListener("DOMContentLoaded", function() {
            var ctx = document.getElementById('chartUsuarios');
            if(ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dados,
                            // PALETA DE CORES PROFISSIONAL E DISTINTA (12 CORES)
                            backgroundColor: [
                                '#20c997', // Pacientes (Verde)
                                '#0d47a1', // Médicos (Azul Marinho)
                                '#3498db', // Enfermeiros (Azul Claro)
                                '#34495e', // Admins (Cinza Escuro)
                                '#9b59b6', // Polos (Roxo)
                                '#e74c3c', // Excluídos (Vermelho)
                                '#f1c40f', // Motoristas (Amarelo Ouro)
                                '#1abc9c', // Técnicos (Verde Água/Teal)
                                '#6610f2', // Clínicas (Indigo/Roxo Escuro)
                                '#d63384', // Laboratórios (Rosa - Igual ao card)
                                '#95a5a6', // Sv. Gerais (Cinza Claro)
                                '#0dcaf0'  // Ambulâncias (Ciano - Igual ao card de ambulância)
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { position: 'right' } },
                        cutout: '70%'
                    }
                });
            }
        });
    </script>
</body>
</html>