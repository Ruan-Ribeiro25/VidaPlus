<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Financeiro - VidaPlus</title>
    <th:block th:replace="~{fragments/favicon :: icone}"></th:block>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Cards com Gradiente */
        .grad-green { background: linear-gradient(45deg, #11998e, #38ef7d) !important; }
        .grad-red { background: linear-gradient(45deg, #cb2d3e, #ef473a) !important; }
        .grad-blue { background: linear-gradient(45deg, #2980b9, #6dd5fa) !important; }

        .card-financeiro {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .card-financeiro:hover { transform: translateY(-3px); }

        .icon-bg-card {
            position: absolute;
            right: 15px;
            bottom: 10px;
            font-size: 3.5rem;
            opacity: 0.25;
            color: #ffffff !important;
        }
        
        /* Texto Branco Forçado */
        .text-white-force { color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Badges de Status (Cores) */
        .status-badge { font-size: 0.8rem; padding: 4px 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .status-pago { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-pendente { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
        .status-atrasado { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .status-cancelado { background-color: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }

        /* Abas */
        .nav-tabs .nav-link { color: #666; cursor: pointer; border: none; font-size: 0.9rem; }
        .nav-tabs .nav-link.active { color: #20c997; border-bottom: 2px solid #20c997; font-weight: bold; background: transparent; }
        .chart-container { position: relative; height: 350px; width: 100%; }
    </style>
</head>
<body>

    <div th:replace="~{fragments/header :: navbar}"></div>

    <main class="container-fluid mt-4 mb-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a th:href="@{/admin/painel}" class="me-3" style="font-size: 1.2rem; text-decoration: none; color: #ffffff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h4 class="m-0 fw-bold" style="font-size: 1.5rem; color: #ffffff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                        <i class="fas fa-chart-line"></i> Gestão Financeira
                    </h4>
                    <small style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.9) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                        Fluxo de Caixa e Relatórios
                    </small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <form th:action="@{/financeiro/gerar-teste}" method="post">
                    <button type="submit" class="btn btn-warning shadow-sm d-flex align-items-center gap-2" 
                            style="width: auto !important; display: inline-flex !important; padding: 6px 12px !important; font-size: 0.8rem !important; border-radius: 50px !important;">
                        <i class="fas fa-magic"></i> <span>Gerar Dados Teste</span>
                    </button>
                </form>

                <button class="btn btn-danger shadow-sm d-flex align-items-center gap-2" 
                        onclick="document.getElementById('modalDespesa').style.display='block'"
                        style="width: auto !important; display: inline-flex !important; padding: 6px 16px !important; font-size: 0.9rem !important; border-radius: 50px !important;">
                    <i class="fas fa-minus-circle"></i> <span>Nova Despesa</span>
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card card-financeiro grad-green p-4">
                    <div style="position: relative; z-index: 2;">
                        <p class="mb-1 text-uppercase fw-bold text-white-force" style="font-size: 0.8rem;">Receitas</p>
                        <h2 class="fw-bold m-0 text-white-force" style="font-size: 2rem;" th:text="'R$ ' + ${#numbers.formatDecimal(totalReceitas, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h2>
                    </div>
                    <i class="fas fa-arrow-up icon-bg-card"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-financeiro grad-red p-4">
                    <div style="position: relative; z-index: 2;">
                        <p class="mb-1 text-uppercase fw-bold text-white-force" style="font-size: 0.8rem;">Despesas</p>
                        <h2 class="fw-bold m-0 text-white-force" style="font-size: 2rem;" th:text="'R$ ' + ${#numbers.formatDecimal(totalDespesas, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h2>
                    </div>
                    <i class="fas fa-arrow-down icon-bg-card"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-financeiro grad-blue p-4">
                    <div style="position: relative; z-index: 2;">
                        <p class="mb-1 text-uppercase fw-bold text-white-force" style="font-size: 0.8rem;">Saldo Líquido</p>
                        <h2 class="fw-bold m-0 text-white-force" style="font-size: 2rem;" th:text="'R$ ' + ${#numbers.formatDecimal(saldoLiquido, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h2>
                    </div>
                    <i class="fas fa-wallet icon-bg-card"></i>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-header bg-white border-bottom-0 pt-3 px-4 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold text-secondary m-0">Análise de Lucro</h5>
                        <ul class="nav nav-tabs card-header-tabs" id="financialTabs" style="font-size: 0.9rem;">
                            <li class="nav-item"><a class="nav-link" href="#" onclick="updateChart('diario', this); return false;">Diário</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" onclick="updateChart('semanal', this); return false;">Semanal</a></li>
                            <li class="nav-item"><a class="nav-link active" href="#" onclick="updateChart('mensal', this); return false;">Mensal</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" onclick="updateChart('anual', this); return false;">Anual</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" onclick="updateChart('decada', this); return false;">10 Anos</a></li>
                        </ul>
                    </div>
                    <div class="card-body px-4 pb-4">
                        <div class="chart-container">
                            <canvas id="graficoFluxo"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="m-0 fw-bold text-secondary">Últimas Movimentações</h6>
                    </div>
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                            <thead class="bg-light text-secondary">
                                <tr>
                                    <th class="ps-4">Descrição</th>
                                    <th>Categoria</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="t : ${transacoes}">
                                    <td class="ps-4 fw-bold text-dark" th:text="${t.descricao}">Consulta</td>
                                    
                                    <td><span class="badge bg-light text-secondary border" th:text="${t.categoria}">CAT</span></td>
                                    
                                    <td class="text-muted" th:text="${#temporals.format(t.dataVencimento, 'dd/MM/yyyy')} ?: '-'">01/01/2026</td>
                                    
                                    <td>
                                        <span class="badge rounded-pill status-badge" 
                                              th:classappend="${t.status.name() == 'PAGO'} ? 'status-pago' : 
                                                             (${t.status.name() == 'PENDENTE'} ? 'status-pendente' : 
                                                             (${t.status.name() == 'ATRASADO'} ? 'status-atrasado' : 'status-cancelado'))">
                                            
                                            <i class="fas" th:classappend="${t.status.name() == 'PAGO'} ? 'fa-check' : 
                                                                         (${t.status.name() == 'ATRASADO'} ? 'fa-exclamation-circle' : 'fa-clock')"></i>
                                            <span th:text="${t.status}">PENDENTE</span>
                                        </span>
                                    </td>

                                    <td class="text-end pe-4 fw-bold" 
                                        th:classappend="${t.tipo.name() == 'RECEITA'} ? 'text-success' : 'text-danger'"
                                        th:text="${t.tipo.name() == 'DESPESA' ? '-' : '+'} + ' R$ ' + ${#numbers.formatDecimal(t.valor, 1, 'POINT', 2, 'COMMA')}">
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(transacoes)}">
                                    <td colspan="5" class="text-center py-4 text-muted">Nenhuma transação registrada.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="m-0 fw-bold text-secondary">Despesas por Categoria</h6>
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div style="height: 250px; width: 100%;">
                            <canvas id="graficoDespesas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="modalDespesa" class="modal" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fs-6"><i class="fas fa-file-invoice-dollar"></i> Nova Saída</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('modalDespesa').style.display='none'"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/financeiro/nova-despesa}" method="post">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Descrição</label>
                            <input type="text" name="descricao" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Valor (R$)</label>
                            <input type="number" name="valor" step="0.01" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label small fw-bold">Vencimento</label>
                                <input type="date" name="dataVencimento" class="form-control">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label small fw-bold">Categoria</label>
                                <select name="categoria" class="form-select" required>
                                    <option value="INSUMOS">Insumos / Farmácia</option>
                                    <option value="FOLHA_PAGAMENTO">Pagamento Func.</option>
                                    <option value="MANUTENCAO">Manutenção</option>
                                    <option value="CONTAS_CONSUMO">Contas (Água, Luz)</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-danger btn-sm">Confirmar Lançamento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: rodape}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const labelsCat = /*[[${labelsGrafico}]]*/ [];
        const valuesCat = /*[[${valoresGrafico}]]*/ [];
        const ctxPie = document.getElementById('graficoDespesas');
        
        if (ctxPie && labelsCat.length > 0) {
            new Chart(ctxPie.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labelsCat,
                    datasets: [{ data: valuesCat, backgroundColor: ['#e74c3c', '#f1c40f', '#9b59b6', '#34495e', '#95a5a6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
            });
        }

        const ctxFluxo = document.getElementById('graficoFluxo').getContext('2d');
        let chartFluxoInstance = null;
        
        // DADOS SIMULADOS PARA GRÁFICO (DEPOIS CONECTAREMOS NO BACKEND)
        const dbData = {
            diario: { labels: ['08h', '10h', '12h', '14h', '16h', '18h'], lucro: [50, 120, 80, 150, 200, 100], despesa: [10, 20, 15, 30, 40, 20] },
            semanal: { labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'], lucro: [3000, 4500, 3200, 5000, 6000, 4000, 1000], despesa: [1000, 1200, 1100, 1500, 2000, 1800, 500] },
            mensal: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], lucro: [12000, 19000, 15000, 25000, 22000, 30000, 28000, 35000, 33000, 40000, 42000, 45000], despesa: [8000, 9000, 8500, 10000, 9500, 11000, 10500, 12000, 11500, 13000, 12500, 14000] },
            anual: { labels: ['2023', '2024', '2025', '2026'], lucro: [150000, 200000, 250000, 320000], despesa: [100000, 120000, 140000, 160000] },
            decada: { labels: ['2020', '2022', '2024', '2026', '2028', '2030'], lucro: [50000, 100000, 200000, 320000, 450000, 600000], despesa: [40000, 80000, 120000, 160000, 200000, 250000] }
        };

        function renderChart(tipo) {
            if (chartFluxoInstance) chartFluxoInstance.destroy();
            let gradient = ctxFluxo.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(32, 201, 151, 0.4)');
            gradient.addColorStop(1, 'rgba(32, 201, 151, 0.0)');

            chartFluxoInstance = new Chart(ctxFluxo, {
                type: 'line',
                data: {
                    labels: dbData[tipo].labels,
                    datasets: [
                        { label: 'Lucro', data: dbData[tipo].lucro, backgroundColor: gradient, borderColor: '#20c997', borderWidth: 2, fill: true, tension: 0.4 },
                        { label: 'Despesa', data: dbData[tipo].despesa, borderColor: '#e74c3c', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [2, 4], color: '#f0f0f0' }, ticks: { callback: v => 'R$ ' + v } } } }
            });
        }

        window.updateChart = function(periodo, element) {
            document.querySelectorAll('#financialTabs .nav-link').forEach(l => l.classList.remove('active'));
            element.classList.add('active');
            renderChart(periodo);
        };

        document.addEventListener("DOMContentLoaded", function() { renderChart('mensal'); });
        /*]]>*/
    </script>
</body>
</html>